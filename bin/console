#!/usr/bin/env php
<?php

$composerAutoload = __DIR__ . '/../vendor/autoload.php';
if (!is_file($composerAutoload)) {
    throw new LogicException('Composer autoload missing. Try running `composer update`.');
}

require_once $composerAutoload;

use Dotenv\Dotenv;
use SpotifyWebAPI\Request;
use SpotifyWebAPI\Session;
use SpotifyWebAPI\SpotifyWebAPI;
use Monolog\Level;
use Monolog\Logger;
use Monolog\ErrorHandler;
use Monolog\Handler\StreamHandler;
use Monolog\Processor\UidProcessor;
use Monolog\Formatter\JsonFormatter;
use Monolog\Handler\RotatingFileHandler;
use Symfony\Component\Console\Application;
use Symfony\Component\Console\Command\Command;
use Symfony\Component\Console\CommandLoader\FactoryCommandLoader;
use StevenFoncken\MultiToolForSpotify\Command\AuthCommand;
use StevenFoncken\MultiToolForSpotify\Command\ArchiveCommand;
use StevenFoncken\MultiToolForSpotify\Command\PlaygroundCommand;
use StevenFoncken\MultiToolForSpotify\Service\AuthService;
use StevenFoncken\MultiToolForSpotify\Service\PlaylistService;
use StevenFoncken\MultiToolForSpotify\Monolog\Handler\ArchivedPlaylistsHandler;

const LOG_DIR_PATH = __DIR__ . '/../var/log/';

const CONFIG_DIR_PATH = __DIR__ . '/../config/';

const ACCESS_TOKEN_PATH = CONFIG_DIR_PATH . 'access_token.txt';

const REFRESH_TOKEN_PATH = CONFIG_DIR_PATH . 'refresh_token.txt';

// ---

$dotenv = Dotenv::createImmutable(CONFIG_DIR_PATH);
$dotenv->load();
$dotenv->required(['DEBUG', 'CLIENT_ID', 'CLIENT_SECRET', 'REDIRECT_URI'])->notEmpty();
$dotenv->required('DEBUG')->isBoolean();

// ---

date_default_timezone_set($_ENV['TIMEZONE']);

// ---

// Init monolog
$logLevel = $_ENV['DEBUG'] ? Level::Debug : Level::Info;

$uidProcessor = new UidProcessor(16);

$rotatingFileHandler = new RotatingFileHandler(LOG_DIR_PATH . 'mtfsp.log', 16, $logLevel);

$archivedPlaylistsHandler = new ArchivedPlaylistsHandler(
        new StreamHandler(LOG_DIR_PATH . 'archived_playlists.log', $logLevel)
);
$archivedPlaylistsHandler->setFormatter(new JsonFormatter());

$logger = new Logger('mtfsp', [$rotatingFileHandler, $archivedPlaylistsHandler], [$uidProcessor]);
ErrorHandler::register($logger);

// ---

$spotifyRequest = new Request(
    [
        'curl_options' => [
            CURLOPT_TIMEOUT => 60,
        ]
    ]
);

// ---

$spotifySession = new Session(
    $_ENV['CLIENT_ID'],
    $_ENV['CLIENT_SECRET'],
    $_ENV['REDIRECT_URI'],
    $spotifyRequest
);

$accessToken = file_get_contents(ACCESS_TOKEN_PATH);
$refreshToken = file_get_contents(REFRESH_TOKEN_PATH);

$spotifySession->setAccessToken($accessToken);
$spotifySession->setRefreshToken($refreshToken);

// ---

$options = array(
    'auto_refresh' => true,
    'auto_retry' => true,
);

$spotifyApi = new SpotifyWebAPI(
    $options,
    $spotifySession,
    $spotifyRequest
);

// ---

// lazy-load commands
$commandLoader = new FactoryCommandLoader([
    'mtfsp:auth' => static function () use ($spotifySession): Command {
        return new AuthCommand(
            new AuthService($spotifySession)
        );
    },
    'mtfsp:archive' => static function () use ($logger, $spotifyApi): Command {
        return new ArchiveCommand(
            $logger->withName('archive_command'),
            new PlaylistService($spotifyApi, $logger->withName('playlist_service'))
        );
    },
    'mtfsp:playground' => static function () use ($logger, $spotifyApi): Command {
        return new PlaygroundCommand(
            $logger->withName('playground_command'),
            new PlaylistService($spotifyApi, $logger->withName('playlist_service'))
        );
    },
]);

$application = new Application('Multi-Tool for Spotify - Console Application', '0.2.0'); // --version
$application->setCatchExceptions(false);
$application->setCommandLoader($commandLoader);
$application->run();

// ---

$newAccessToken = $spotifySession->getAccessToken();
$newRefreshToken = $spotifySession->getRefreshToken();

file_put_contents(ACCESS_TOKEN_PATH, $newAccessToken);
file_put_contents(REFRESH_TOKEN_PATH, $newRefreshToken);
