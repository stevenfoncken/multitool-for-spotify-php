#!/usr/bin/env php
<?php

$composerAutoload = __DIR__ . '/../vendor/autoload.php';
if (!is_file($composerAutoload)) {
    throw new LogicException('Composer autoload missing. Try running `composer update`.');
}

require_once $composerAutoload;

use Symfony\Component\Console\Application;
use Symfony\Component\Console\CommandLoader\FactoryCommandLoader;
use StevenFoncken\MultiToolForSpotify\Command\AuthCommand;
use StevenFoncken\MultiToolForSpotify\Service\AuthService;
use Dotenv\Dotenv;
use SpotifyWebAPI\Session;

// ---

$dotenv = Dotenv::createImmutable(__DIR__ . '/../config/');
$dotenv->load();
$dotenv
    ->required(['CLIENT_ID', 'CLIENT_SECRET', 'REDIRECT_URI'])
    ->notEmpty();

// ---

$spotifySession = new Session(
    $_ENV['CLIENT_ID'],
    $_ENV['CLIENT_SECRET'],
    $_ENV['REDIRECT_URI']
);

// ---

// lazy-load commands
$commandLoader = new FactoryCommandLoader([
    'mtfsp:auth' => static function () use($spotifySession) { return new AuthCommand(new AuthService($spotifySession)); },
]);

$application = new Application('Multi-Tool for Spotify - Console Application', '0.2.0'); // --version
$application->setCommandLoader($commandLoader);
$application->run();
